<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="Sklad_2.Views.LoyaltyPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid Padding="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Grid.Row="0" Text="Věrnostní program" Style="{StaticResource TitleTextBlockStyle}" Margin="0,0,0,20"/>

        <!-- InfoBar pro zprávy -->
        <InfoBar Grid.Row="0"
                 Margin="0,50,0,0"
                 IsOpen="{x:Bind ViewModel.StatusMessage, Mode=OneWay, Converter={StaticResource StringToBoolConverter}}"
                 Severity="{x:Bind ViewModel.IsError, Mode=OneWay, Converter={StaticResource BooleanToInfoBarSeverityConverter}}"
                 Message="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                 IsClosable="True"
                 Closed="InfoBar_Closed"/>

        <!-- Přidat člena + Vyhledávání -->
        <Grid Grid.Row="1" Margin="0,0,0,15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Formulář pro přidání člena -->
            <Border Grid.Column="0"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1" CornerRadius="8" Padding="15"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    Margin="0,0,15,0">
                <StackPanel>
                    <TextBlock Text="Nový člen" FontWeight="SemiBold" Margin="0,0,0,10"/>
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <TextBox x:Name="FirstNameBox"
                                 PlaceholderText="Jméno *"
                                 Text="{x:Bind ViewModel.NewFirstName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 Width="120"/>
                        <TextBox x:Name="LastNameBox"
                                 PlaceholderText="Příjmení *"
                                 Text="{x:Bind ViewModel.NewLastName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 Width="120"/>
                        <TextBox x:Name="EmailBox"
                                 PlaceholderText="Email"
                                 Text="{x:Bind ViewModel.NewEmail, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 Width="180"/>
                        <StackPanel Orientation="Horizontal" Spacing="3">
                            <TextBlock Text="+420" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="#666"/>
                            <TextBox x:Name="PhoneNumberBox"
                                     PlaceholderText="Tel. číslo *"
                                     Text="{x:Bind ViewModel.NewPhoneNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     Width="100"/>
                        </StackPanel>
                        <TextBox x:Name="CardEanBox"
                                 PlaceholderText="EAN kartičky"
                                 Text="{x:Bind ViewModel.NewCardEan, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 Width="140"/>
                        <Button Content="Přidat"
                                Command="{x:Bind ViewModel.AddCustomerCommand}"
                                Style="{StaticResource AccentButtonStyle}"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Vyhledávání -->
            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                <TextBox PlaceholderText="Hledat (jméno, email, telefon, EAN)..."
                         Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         Width="250"/>
            </StackPanel>
        </Grid>

        <!-- Seznam členů -->
        <Border Grid.Row="2"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1" CornerRadius="8" Padding="15"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Hlavička tabulky -->
                <Grid Grid.Row="0" Padding="10,5" Background="#F0F0F0" CornerRadius="4" Margin="0,0,0,5">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="130"/>
                        <ColumnDefinition Width="130"/>
                        <ColumnDefinition Width="180"/>
                        <ColumnDefinition Width="110"/>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="80"/>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="Jméno" FontWeight="SemiBold" FontSize="12"/>
                    <TextBlock Grid.Column="1" Text="Příjmení" FontWeight="SemiBold" FontSize="12"/>
                    <TextBlock Grid.Column="2" Text="Email" FontWeight="SemiBold" FontSize="12"/>
                    <TextBlock Grid.Column="3" Text="Telefon" FontWeight="SemiBold" FontSize="12"/>
                    <TextBlock Grid.Column="4" Text="Kartička" FontWeight="SemiBold" FontSize="12"/>
                    <TextBlock Grid.Column="5" Text="Sleva" FontWeight="SemiBold" FontSize="12" HorizontalAlignment="Right"/>
                    <TextBlock Grid.Column="6" Text="Celkem nakoupil" FontWeight="SemiBold" FontSize="12" HorizontalAlignment="Right"/>
                    <TextBlock Grid.Column="7" Text="Akce" FontWeight="SemiBold" FontSize="12" HorizontalAlignment="Center"/>
                </Grid>

                <!-- Seznam -->
                <ListView Grid.Row="1"
                          ItemsSource="{x:Bind ViewModel.Customers, Mode=OneWay}"
                          SelectedItem="{x:Bind ViewModel.SelectedCustomer, Mode=TwoWay}"
                          SelectionMode="Single">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0"/>
                            <Setter Property="MinHeight" Value="40"/>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <Grid Padding="10,8" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="130"/>
                                    <ColumnDefinition Width="130"/>
                                    <ColumnDefinition Width="180"/>
                                    <ColumnDefinition Width="110"/>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{Binding FirstName}" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1" Text="{Binding LastName}" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="2" Text="{Binding Email}" VerticalAlignment="Center" Opacity="0.8" FontSize="12"/>
                                <TextBlock Grid.Column="3" Text="{Binding PhoneNumberFormatted}" VerticalAlignment="Center" Opacity="0.7" FontSize="12"/>
                                <TextBlock Grid.Column="4" Text="{Binding CardEanFormatted}" VerticalAlignment="Center" Opacity="0.7" FontSize="12"/>
                                <TextBlock Grid.Column="5" Text="{Binding DiscountFormatted}" VerticalAlignment="Center"
                                           HorizontalAlignment="Right" FontWeight="SemiBold"
                                           Foreground="#007AFF"/>
                                <TextBlock Grid.Column="6" Text="{Binding TotalPurchasesFormatted}" VerticalAlignment="Center"
                                           HorizontalAlignment="Right" Foreground="#34C759"/>
                                <StackPanel Grid.Column="7" Orientation="Horizontal" HorizontalAlignment="Center" Spacing="5">
                                    <Button Content="Upravit" Click="EditButton_Click" FontSize="11" Padding="8,4"/>
                                    <Button Content="Smazat" Click="DeleteButton_Click" FontSize="11" Padding="8,4"
                                            Background="#FF3B30" Foreground="White"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>
        </Border>

        <!-- Footer: Statistiky + Akce -->
        <Grid Grid.Row="3" Margin="0,15,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Statistiky -->
            <StackPanel Orientation="Horizontal" Spacing="30">
                <TextBlock VerticalAlignment="Center">
                    <Run Text="Celkem členů: " Foreground="#666"/>
                    <Run Text="{x:Bind ViewModel.TotalCount, Mode=OneWay}" FontWeight="SemiBold"/>
                </TextBlock>
                <TextBlock VerticalAlignment="Center">
                    <Run Text="Se slevou: " Foreground="#666"/>
                    <Run Text="{x:Bind ViewModel.WithDiscountCount, Mode=OneWay}" FontWeight="SemiBold"/>
                </TextBlock>
                <TextBlock VerticalAlignment="Center">
                    <Run Text="Celkem nakoupili: " Foreground="#666"/>
                    <Run Text="{x:Bind ViewModel.TotalPurchasesSumFormatted, Mode=OneWay}" FontWeight="SemiBold" Foreground="#34C759"/>
                </TextBlock>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
